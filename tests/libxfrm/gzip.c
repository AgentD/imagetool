/* SPDX-License-Identifier: GPL-3.0-or-later */
/*
 * gzip.c
 *
 * Copyright (C) 2021 David Oberhollenzer <goliath@infraroot.at>
 */
#include "xfrm.h"
#include "test.h"

static const char orig[] = "The quick brown fox jumps over the lazy dog\n";

static const uint8_t gz_in[] = {
	0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x03, 0x0b, 0xc9, 0x48, 0x55, 0x28, 0x2c,
	0xcd, 0x4c, 0xce, 0x56, 0x48, 0x2a, 0xca, 0x2f,
	0xcf, 0x53, 0x48, 0xcb, 0xaf, 0x50, 0xc8, 0x2a,
	0xcd, 0x2d, 0x28, 0x56, 0xc8, 0x2f, 0x4b, 0x2d,
	0x52, 0x28, 0x01, 0x4a, 0xe7, 0x24, 0x56, 0x55,
	0x2a, 0xa4, 0xe4, 0xa7, 0x73, 0x01, 0x00, 0x38,
	0xc1, 0x93, 0x6d, 0x2c, 0x00, 0x00, 0x00
};

static const uint8_t zlib_in[] = {
	0x78, 0x9c, 0x0b, 0xc9, 0x48, 0x55, 0x28, 0x2c,
	0xcd, 0x4c, 0xce, 0x56, 0x48, 0x2a, 0xca, 0x2f,
	0xcf, 0x53, 0x48, 0xcb, 0xaf, 0x50, 0xc8, 0x2a,
	0xcd, 0x2d, 0x28, 0x56, 0xc8, 0x2f, 0x4b, 0x2d,
	0x52, 0x28, 0x01, 0x4a, 0xe7, 0x24, 0x56, 0x55,
	0x2a, 0xa4, 0xe4, 0xa7, 0x73, 0x01, 0x00, 0x6b,
	0xc0, 0x0f, 0xe4
};

int main(void)
{
	uint32_t in_diff = 0, out_diff = 0;
	xfrm_stream_t *xfrm;
	char buffer[128];
	int ret;

	/* uncompress gzip file */
	xfrm = decompressor_stream_gzip_create();
	TEST_NOT_NULL(xfrm);
	TEST_EQUAL_UI(((object_t *)xfrm)->refcount, 1);

	ret = xfrm->process_data(xfrm, gz_in, sizeof(gz_in),
				 buffer, sizeof(buffer),
				 &in_diff, &out_diff, 0);
	TEST_EQUAL_I(ret, XFRM_STREAM_END);

	TEST_EQUAL_UI(in_diff, sizeof(gz_in));
	TEST_EQUAL_UI(out_diff, sizeof(orig) - 1);
	ret = memcmp(buffer, orig, out_diff);
	TEST_EQUAL_I(ret, 0);

	object_drop(xfrm);

	/* uncompress zlib stream */
	xfrm = decompressor_stream_zlib_create();
	TEST_NOT_NULL(xfrm);
	TEST_EQUAL_UI(((object_t *)xfrm)->refcount, 1);

	in_diff = 0;
	out_diff = 0;
	ret = xfrm->process_data(xfrm, zlib_in, sizeof(zlib_in),
				 buffer, sizeof(buffer),
				 &in_diff, &out_diff, 0);
	TEST_EQUAL_I(ret, XFRM_STREAM_END);

	TEST_EQUAL_UI(in_diff, sizeof(zlib_in));
	TEST_EQUAL_UI(out_diff, sizeof(orig) - 1);
	ret = memcmp(buffer, orig, out_diff);
	TEST_EQUAL_I(ret, 0);

	object_drop(xfrm);
	return EXIT_SUCCESS;
}
